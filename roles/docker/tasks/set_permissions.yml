---
- name: Ensure /opt/airconcheck exists with correct ownership
  file:
    path: "{{ global_defaults.app_base_path }}"
    state: directory
    owner: dockeruser
    group: dockeruser
    mode: '0755'

- name: Set correct ownership and permissions for service directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ global_defaults.app_base_path }}/portainer", owner: "dockeruser", group: "dockeruser", mode: "0755" }
    - { path: "{{ global_defaults.app_base_path }}/swag/external", owner: "jose", group: "jose", mode: "0755" }
    - { path: "{{ global_defaults.app_base_path }}/swag/internal", owner: "jose", group: "jose", mode: "0755" }
    - { path: "{{ global_defaults.app_base_path }}/frontend/dist", owner: "jose", group: "jose", mode: "0755" }

- name: Ensure 'webcontent' group exists
  group:
    name: webcontent
    state: present

- name: Ensure user 'jose' is in 'webcontent' group
  user:
    name: jose
    groups: webcontent
    append: yes

- name: Ensure ACL tools are present
  apt:
    name: acl
    state: present
    update_cache: yes

- name: Ensure content directories exist (landpage/html, angular-ssr, backend)
  file:
    path: "{{ item }}"
    state: directory
    owner: dockeruser
    group: webcontent
    mode: '2775'
  loop:
    - "{{ global_defaults.app_base_path }}/landpage/html"
    - "{{ global_defaults.angular_ssr_build_context | default(global_defaults.app_base_path + '/angular-ssr') }}"
    - "{{ global_defaults.backend_build_context | default(global_defaults.app_base_path + '/backend') }}"

- name: Apply default ACL for group webcontent (rwx) on content directories
  ansible.posix.acl:
    path: "{{ item }}"
    entity: group:webcontent
    etype: group
    permissions: rwx
    state: present
    default: yes
  loop:
    - "{{ global_defaults.app_base_path }}/landpage/html"
    - "{{ global_defaults.angular_ssr_build_context | default(global_defaults.app_base_path + '/angular-ssr') }}"
    - "{{ global_defaults.backend_build_context | default(global_defaults.app_base_path + '/backend') }}"

- name: Ensure default ACL mask allows group rwx on content directories
  ansible.posix.acl:
    path: "{{ item }}"
    entity: mask
    etype: mask
    permissions: rwx
    state: present
    default: yes
  loop:
    - "{{ global_defaults.app_base_path }}/landpage/html"
    - "{{ global_defaults.angular_ssr_build_context | default(global_defaults.app_base_path + '/angular-ssr') }}"
    - "{{ global_defaults.backend_build_context | default(global_defaults.app_base_path + '/backend') }}"

