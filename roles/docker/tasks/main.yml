---
#- name: Load environment variables
#  include_vars:
#    file: "{{ playbook_dir }}/../group_vars/all.yml"
- import_tasks: load_globals.yml
  tags: [always]

- name: Delete docker snap
  command: snap remove docker
  ignore_errors: yes

- name: Install docker requeriments
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
    state: present
    update_cache: yes

- name: Add docker GPG key
  shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/docker-archive-keyring.gpg

- name: Add docker repo
  shell: echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  args:
    creates: /etc/apt/sources.list.d/docker.list

- name: Install Docker and Docker Compose
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: Enable and start Docker
  systemd:
    name: docker
    enabled: yes
    state: started

- name: Add 'dockeruser' at docker group
  user:
    name: dockeruser
    groups: docker
    append: yes

- name: Create docker networks
  docker_network:
    name: "{{ item.name }}"
    driver: bridge
    internal: "{{ item.internal }}"
  loop: "{{ docker_networks }}"

- name: Create app directories
  file:
    path: "{{ item }}"
    state: directory
    owner: dockeruser
    group: dockeruser
    mode: '0755'
  loop: "{{ app_directories }}"

- name: Check if landpage index.html already exists
  stat:
    path: "{{ global_defaults.app_base_path }}/landpage/html/index.html"
  register: landpage_index_stat
  when: deploy_landpage | default(false)
  tags: [landpage]

- name: Render landpage index.html from template (only if absent)
  template:
    src: templates/landpage/index.html.j2
    dest: "{{ global_defaults.app_base_path }}/landpage/html/index.html"
    owner: dockeruser
    group: dockeruser
    mode: "0664"
  when: deploy_landpage | default(false) and not (landpage_index_stat.stat.exists | default(false))
  tags: [landpage]

- name: Render landpage nginx default.conf (SPA fallback)
  template:
    src: templates/landpage/default.conf.j2
    dest: "{{ global_defaults.app_base_path }}/landpage/nginx/default.conf"
    owner: dockeruser
    group: dockeruser
    mode: "0644"
  when: deploy_landpage | default(false)
  tags: [landpage]

- name: Render Netdata configuration (persistent dbengine)
  template:
    src: templates/netdata/netdata.conf.j2
    dest: "{{ global_defaults.app_base_path }}/netdata/config/netdata.conf"
    owner: dockeruser
    group: dockeruser
    mode: "0644"
  when: deploy_netdata | default(true)

 

- name: Configurar SWAG
  import_tasks: configure_swag.yml
  tags: [landpage]

- import_tasks: set_permissions.yml
- import_tasks: deploy_containers.yml
