---
- name: Ensure MongoDB base directory exists
  file:
    path: "{{ global_defaults.app_base_path }}/mongodb"
    state: directory
    mode: '0755'

- name: Check if MongoDB keyFile exists
  stat:
    path: "{{ global_defaults.app_base_path }}/mongodb/keyfile"
  register: keyfile_stat

- name: Create MongoDB keyFile (once)
  copy:
    content: "{{ lookup('password', '/dev/null length=64 chars=ascii_letters') | trim }}"
    dest: "{{ global_defaults.app_base_path }}/mongodb/keyfile"
    mode: "0400"
    owner: "999"
    group: "999"
  when: not keyfile_stat.stat.exists | default(false)

- name: Ensure MongoDB keyFile ownership and mode
  file:
    path: "{{ global_defaults.app_base_path }}/mongodb/keyfile"
    owner: "999"
    group: "999"
    mode: "0400"

- name: Derive PBM agent credentials
  ansible.builtin.set_fact:
    mongodb_pbm_agent_user_effective: "{{ mongodb_pbm_agent_user | default(mongo_pbm_mongodb_user | default(mongo_pmm_user | default('')), true) }}"
    mongodb_pbm_agent_password_effective: "{{ mongodb_pbm_agent_password | default(mongo_pbm_mongodb_password | default(mongo_pmm_password | default('')), true) }}"
    mongodb_pbm_agent_auth_db_effective: "{{ mongodb_pbm_agent_auth_db | default(mongo_pbm_auth_db | default('admin'), true) }}"
  when: mongodb_pbm_agent_enabled | default(false)

- name: Validate PBM agent prerequisites
  ansible.builtin.assert:
    that:
      - mongodb_pbm_agent_user_effective is defined
      - mongodb_pbm_agent_user_effective | length > 0
      - mongodb_pbm_agent_password_effective is defined
      - mongodb_pbm_agent_password_effective | length > 0
    fail_msg: >-
      PBM agents are enabled but no credentials were provided. Set
      mongo_pbm_mongodb_user/mongo_pbm_mongodb_password (or the
      mongodb_pbm_agent_* overrides).
  when: mongodb_pbm_agent_enabled | default(false)


- name: Copy docker-compose template for MongoDB Replica Set
  template:
    src: docker-compose.yml.j2
    dest: "{{ global_defaults.app_base_path }}/mongodb/docker-compose.yml"

- name: TUMBAR la stack MongoDB (anterior)
  community.docker.docker_compose_v2:
    project_src: "{{ global_defaults.app_base_path }}/mongodb"
    state: absent           # â†“ docker compose down
  register: down_result
  changed_when: down_result.removed | default(false)

- name: Pull and up MongoDB replica set
  community.docker.docker_compose_v2:
    project_src: "{{ global_defaults.app_base_path }}/mongodb"
    build: always
    pull: always
    state: present
    recreate: always
    remove_orphans: true

- name: Init replica set
  include_tasks: init_replica_set.yml
  # Only run once (if you need to ensure idempotency, might add check)
  when: inventory_hostname == groups['all'][0]