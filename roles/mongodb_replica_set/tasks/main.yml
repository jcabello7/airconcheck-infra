---
- name: Ensure MongoDB base directory exists
  file:
    path: "{{ global_defaults.app_base_path }}/mongodb"
    state: directory
    mode: '0755'

- name: Ensure keyFile exists
  copy:
    content: "{{ lookup('password', '/dev/null length=1024 chars=ascii_letters') }}"
    dest: "{{ global_defaults.app_base_path }}/mongodb/keyfile"
    mode: "0400"
    owner: root
  register: keyfile_created


- name: Copy docker-compose template for MongoDB Replica Set
  template:
    src: docker-compose.yml.j2
    dest: "{{ global_defaults.app_base_path }}/mongodb/docker-compose.yml"

- name: Pull and up MongoDB replica set
  community.docker.docker_compose:
    project_src: "{{ global_defaults.app_base_path }}/mongodb"
    state: present
    recreate: always
    restarted: yes

- name: Init replica set
  include_tasks: init_replica_set.yml
  # Only run once (if you need to ensure idempotency, might add check)
  when: inventory_hostname == groups['all'][0]