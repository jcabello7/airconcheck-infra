{
  errors
  health
  ready
}

{% set passthrough_forwarders = coredns_passthrough_forwarders | default([]) %}
{% set passthrough_targets = passthrough_forwarders if (passthrough_forwarders | length > 0) else (coredns_forwarders | default([])) %}
{% for domain in coredns_passthrough_domains | default([]) %}
{{ domain }}:53 {
  {% if passthrough_targets | length > 0 %}
  forward . {{ passthrough_targets | join(' ') }}
  {% else %}
  forward . /etc/resolv.conf
  {% endif %}
}

{% endfor %}
{% for z in coredns_zones %}
{{ z.zone }}:53 {
  {% if z.wildcard_to is defined %}
  # Mode 2: wildcard synthesizer + forward rest (exclude apex)
  template IN A {{ z.zone }} {
    match "^(.+[.]){{ z.zone | replace('.', '[.]') }}[.]$"
    answer "{{'{{'}}.Name{{'}}'}} 300 IN A {{ (z.wildcard_to == 'TAILSCALE_SELF') | ternary(coredns_bind_ip_effective, z.wildcard_to) }}"
    fallthrough
  }
  {% if (coredns_apex_internal | default(true)) %}
  # Optional: also synthesize apex to Tailscale/internal
  template IN A {{ z.zone }} {
    match "^{{ z.zone | replace('.', '[.]') }}[.]$"
    answer "{{'{{'}}.Name{{'}}'}} 300 IN A {{ (z.wildcard_to == 'TAILSCALE_SELF') | ternary(coredns_bind_ip_effective, z.wildcard_to) }}"
    fallthrough
  }
  {% endif %}
  {# Forward anything not synthesized above. If apex_internal is false, prefer Cloudflare #}
  {% if (coredns_apex_internal | default(true)) %}
    {% set fwd = (coredns_forwarders | default([])) %}
    {% if fwd | length > 0 %}
  forward . {{ fwd | join(' ') }}
    {% else %}
  forward . /etc/resolv.conf
    {% endif %}
  {% else %}
  forward . 1.1.1.1 1.0.0.1
  {% endif %}
  {% else %}
  # Mode 1: file-based authoritative zone
  file /etc/coredns/zone_{{ z.zone }}.db
  {% endif %}
}
{% endfor %}

{% set fwd = (coredns_forwarders | default([])) %}
. {
  {% if fwd | length > 0 %}
  forward . {{ fwd | join(' ') }}
  {% else %}
  forward . /etc/resolv.conf
  {% endif %}
  cache 300
  reload
}
